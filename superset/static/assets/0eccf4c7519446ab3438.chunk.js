"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[4946],{24946:(e,t,i)=>{i.r(t),i.d(t,{default:()=>z,getLayer:()=>V});var n=i(67294),r=i(45697),a=i.n(r),o=i(78918),s=i(80744),l=i(38550),d=i(71435),h=i(62112),c=i(99890),u=i(98452);const g=[0,0,0,255],p={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:e=>e.polygon},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:g},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class f extends o.Z{initializeState(){this.state={paths:[]},this.props.getLineDashArray&&s.Z.removed("getLineDashArray","PathStyleExtension")()}updateState({oldProps:e,props:t,changeFlags:i}){const n=i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon);if(n&&Array.isArray(i.dataChanged)){const e=this.state.paths.slice(),t=i.dataChanged.map((t=>(0,u.b)({data:e,getIndex:e=>e.__source.index,dataRange:t,replace:this._getPaths(t)})));this.setState({paths:e,pathsDiff:t})}else n&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:t,getPolygon:i,positionFormat:n,_normalize:r}=this.props,a=[],o="XY"===n?2:3,{startRow:s,endRow:d}=e,{iterable:h,objectInfo:u}=(0,l.jB)(t,s,d);for(const e of h){u.index++;let t=i(e,u);r&&(t=c.F(t,o));const{holeIndices:n}=t,s=t.positions||t;if(n)for(let t=0;t<=n.length;t++){const i=s.slice(n[t-1]||0,n[t]||s.length);a.push(this.getSubLayerRow({path:i},e,u.index))}else a.push(this.getSubLayerRow({path:s},e,u.index))}return a}renderLayers(){const{data:e,_dataDiff:t,stroked:i,filled:n,extruded:r,wireframe:a,_normalize:o,_windingOrder:s,elevationScale:l,transitions:c,positionFormat:u}=this.props,{lineWidthUnits:p,lineWidthScale:f,lineWidthMinPixels:m,lineWidthMaxPixels:y,lineJointRounded:_,lineMiterLimit:b,lineDashJustified:v}=this.props,{getFillColor:C,getLineColor:L,getLineWidth:S,getLineDashArray:w,getElevation:x,getPolygon:k,updateTriggers:P,material:A}=this.props,{paths:F,pathsDiff:D}=this.state,R=this.getSubLayerClass("fill",d.Z),Z=this.getSubLayerClass("stroke",h.Z),W=this.shouldRenderSubLayer("fill",F)&&new R({_dataDiff:t,extruded:r,elevationScale:l,filled:n,wireframe:a,_normalize:o,_windingOrder:s,getElevation:x,getFillColor:C,getLineColor:r&&a?L:g,material:A,transitions:c},this.getSubLayerProps({id:"fill",updateTriggers:{getPolygon:P.getPolygon,getElevation:P.getElevation,getFillColor:P.getFillColor,lineColors:r&&a,getLineColor:P.getLineColor}}),{data:e,positionFormat:u,getPolygon:k});return[!r&&W,!r&&i&&this.shouldRenderSubLayer("stroke",F)&&new Z({_dataDiff:D&&(()=>D),widthUnits:p,widthScale:f,widthMinPixels:m,widthMaxPixels:y,jointRounded:_,miterLimit:b,dashJustified:v,_pathType:"loop",transitions:c&&{getWidth:c.getLineWidth,getColor:c.getLineColor,getPath:c.getPolygon},getColor:this.getSubLayerAccessor(L),getWidth:this.getSubLayerAccessor(S),getDashArray:this.getSubLayerAccessor(w)},this.getSubLayerProps({id:"stroke",updateTriggers:{getWidth:P.getLineWidth,getColor:P.getLineColor,getDashArray:P.getLineDashArray}}),{data:F,positionFormat:u,getPath:e=>e.path}),r&&W]}}f.layerName="PolygonLayer",f.defaultProps=p;var m=i(85531),y=i(36665),_=i(1740),b=i(4065);function v(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function C(e){let t=e,i=e;function n(e,t,n,r){for(null==n&&(n=0),null==r&&(r=e.length);n<r;){const a=n+r>>>1;i(e[a],t)<0?n=a+1:r=a}return n}return 1===e.length&&(t=(t,i)=>e(t)-i,i=function(e){return(t,i)=>v(e(t),i)}(e)),{left:n,center:function(e,i,r,a){null==r&&(r=0),null==a&&(a=e.length);const o=n(e,i,r,a-1);return o>r&&t(e[o-1],i)>-t(e[o],i)?o-1:o},right:function(e,t,n,r){for(null==n&&(n=0),null==r&&(r=e.length);n<r;){const a=n+r>>>1;i(e[a],t)>0?r=a:n=a+1}return n}}}const L=C(v),S=L.right,w=(L.left,C((function(e){return null===e?NaN:+e})).center,S);function x(e,t){switch(arguments.length){case 0:break;case 1:this.range(e);break;default:this.range(t).domain(e)}return this}function k(){var e,t=[.5],i=[0,1],n=1;function r(r){return null!=r&&r<=r?i[w(t,r,0,n)]:e}return r.domain=function(e){return arguments.length?(t=Array.from(e),n=Math.min(t.length,i.length-1),r):t.slice()},r.range=function(e){return arguments.length?(i=Array.from(e),n=Math.min(t.length,i.length-1),r):i.slice()},r.invertExtent=function(e){var n=i.indexOf(e);return[t[n-1],t[n]]},r.unknown=function(t){return arguments.length?(e=t,r):e},r.copy=function(){return k().domain(t).range(i).unknown(e)},x.apply(r,arguments)}var P=i(2995),A=i(45511),F=i(64106);function D({break_points:e,num_buckets:t},i,n){if(!i)return[];if(void 0===e||0===e.length){const e=t?parseInt(t,10):10,[r,a]=(0,b.extent)(i,n);if(void 0===r)return[];const o=(a-r)/e,s=0===o?0:Math.max(0,Math.ceil(Math.log10(1/o))),l=a>a.toFixed(s)?1:0,d=r<r.toFixed(s)?r-1:r;return new Array(e+1+l).fill().map(((e,t)=>(d+t*o).toFixed(s)))}return e.sort(((e,t)=>parseFloat(e)-parseFloat(t)))}function R({break_points:e,num_buckets:t,linear_color_scheme:i,opacity:n},r,a){const o=e||t?D({break_points:e,num_buckets:t},r,a):null,s=Array.isArray(i)?new P.Z({colors:i,id:"custom"}):(0,A.Z)().get(i);let l,d;if(null!==o){const e=o.length-1,t=e>1?s.getColors(e):[s.colors[s.colors.length-1]],i=t[0],n=t[t.length-1];t.unshift(i),t.push(n);const r=o.map((e=>parseFloat(e)));l=k().domain(r).range(t),d=t=>t>o[e]||t<o[0]}else l=s.createLinearScale((0,b.extent)(r,a)),d=()=>!1;return e=>{const t=a(e),i=(0,F.hexToRGB)(l(t));return d(t)?i[3]=0:i[3]=n/100*255,i}}var Z=i(52154),W=i(66911),T=i(21207);function M(e){return"geometry"in e.polygon?e.polygon.geometry.coordinates[0]:e.polygon}var j=i(40461),E=i(11965);function V(e,t,i,n,r,a,o){const s=e,l=s.fill_color_picker,d=s.stroke_color_picker;let h=[...t.data.features];if(null!=o&&o.forEach((e=>{h=h.filter((t=>e(t)))})),s.js_data_mutator){const e=(0,T.Z)(s.js_data_mutator);h=e(h)}const c=s.metric?s.metric.label||s.metric:null,u=null===s.metric?()=>[l.r,l.g,l.b,255*l.a]:R(s,h,(e=>e[c])),g=e=>{const t=u(e);return r.length>0&&!r.includes(e[s.line_column])&&(t[3]/=2),t},p=s.line_column&&s.metric&&["json","geohash","zipcode"].includes(s.line_type)?function(e){return t=>{const i=e.metric.label||e.metric;return(0,E.tZ)("div",{className:"deckgl-tooltip"},t.object.name&&(0,E.tZ)(_.Z,{label:"name: ",value:`${t.object.name}`}),t.object[e.line_column]&&(0,E.tZ)(_.Z,{label:`${e.line_column}: `,value:`${t.object[e.line_column]}`}),e.metric&&(0,E.tZ)(_.Z,{label:`${i}: `,value:`${t.object[i]}`}))}}(s):void 0;return new f({id:`path-layer-${s.slice_id}`,data:h,pickable:!0,filled:s.filled,stroked:s.stroked,getPolygon:M,getFillColor:g,getLineColor:[d.r,d.g,d.b,255*d.a],getLineWidth:s.line_width,extruded:s.extruded,getElevation:e=>function(e,t){return 0===t(e)[3]?0:e.elevation}(e,g),elevationScale:s.multiplier,fp64:!0,...(0,Z.N)(s,n,p,a)})}const N={formData:a().object.isRequired,payload:a().object.isRequired,setControlValue:a().func.isRequired,viewport:a().object.isRequired,onAddFilter:a().func,width:a().number.isRequired,height:a().number.isRequired},$={onAddFilter(){}};class q extends n.Component{constructor(e){super(e),this.containerRef=n.createRef(),this.setTooltip=e=>{const{current:t}=this.containerRef;t&&t.setTooltip(e)},this.state=q.getDerivedStateFromProps(e),this.getLayers=this.getLayers.bind(this),this.onSelect=this.onSelect.bind(this),this.onValuesChange=this.onValuesChange.bind(this)}static getDerivedStateFromProps(e,t){const{width:i,height:n,formData:r,payload:a}=e;if(t&&a.form_data===t.formData)return null;const o=a.data.features||[],s=o.map((e=>e.__timestamp)),l=a.form_data.time_grain_sqla||a.form_data.granularity||"P1D",{start:d,end:h,getStep:c,values:u,disabled:g}=(0,W.g)(s,l);let{viewport:p}=e;return r.autozoom&&(p=(0,j.Z)(p,{width:i,height:n,points:o.flatMap(M)})),{start:d,end:h,getStep:c,values:u,disabled:g,viewport:p,selected:[],lastClick:0,formData:a.form_data}}onSelect(e){const{formData:t,onAddFilter:i}=this.props,n=new Date,r=n-this.state.lastClick<=250,a=[...this.state.selected];if(r)a.splice(0,a.length,e);else if(t.toggle_polygons){const t=a.indexOf(e);-1===t?a.push(e):a.splice(t,1)}else a.splice(0,1,e);this.setState({selected:a,lastClick:n}),t.table_filter&&i(t.line_column,a,!1,!0)}onValuesChange(e){this.setState({values:Array.isArray(e)?e:[e,e+this.state.getStep(e)]})}getLayers(e){if(void 0===this.props.payload.data.features)return[];const t=[];return e[0]===e[1]||e[1]===this.end?t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<=e[1])):t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<e[1])),[V(this.props.formData,this.props.payload,this.props.onAddFilter,this.setTooltip,this.state.selected,this.onSelect,t)]}render(){const{payload:e,formData:t,setControlValue:i}=this.props,{start:n,end:r,getStep:a,values:o,disabled:s,viewport:l}=this.state,d=t,h=d.metric?d.metric.label||d.metric:null,c=function(e,t,i){const n=D(e,t,i),r=R(e,t,i),a={};return n.slice(1).forEach(((t,i)=>{const o=`${n[i]} - ${n[i+1]}`,s=.5*(parseFloat(n[i])+parseFloat(n[i+1])),l=e.metric?e.metric.label||e.metric:null;a[o]={color:r({[l||e.metric]:s}),enabled:!0}})),a}(t,e.data.features,(e=>e[h]));return(0,E.tZ)("div",{style:{position:"relative"}},(0,E.tZ)(m.Z,{ref:this.containerRef,aggregation:!0,getLayers:this.getLayers,start:n,end:r,getStep:a,values:o,disabled:s,viewport:l,width:this.props.width,height:this.props.height,mapboxApiAccessToken:e.data.mapboxApiKey,mapStyle:t.mapbox_style,setControlValue:i,onValuesChange:this.onValuesChange,onViewportChange:this.onViewportChange},null!==t.metric&&(0,E.tZ)(y.Z,{categories:c,position:t.legend_position,format:t.legend_format})))}}q.propTypes=N,q.defaultProps=$;const z=q}}]);
//# sourceMappingURL=0eccf4c7519446ab3438.chunk.js.map